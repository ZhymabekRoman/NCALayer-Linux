name: Package Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download-and-cache:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure DNS for reliable resolution
        run: |
          echo "Configuring DNS servers..."
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
          echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf > /dev/null
          echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf > /dev/null
          cat /etc/resolv.conf

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl aria2

      - name: Cache ncalayer.zip
        id: cache-ncalayer
        uses: actions/cache@v4
        with:
          path: ncalayer.zip
          key: ncalayer-${{ hashFiles('Makefile') }}-fc44f518042ff8daf6087cd6dcc667cb

      - name: Download ncalayer.zip with retry
        if: steps.cache-ncalayer.outputs.cache-hit != 'true'
        run: |
          echo "Downloading ncalayer.zip..."
          MAX_ATTEMPTS=3
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            if make download; then
              echo "Download successful!"
              break
            else
              echo "Download failed on attempt $ATTEMPT"

              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "All download attempts failed!"
                exit 1
              fi

              echo "Waiting 15 seconds before retry..."
              sleep 15
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done

      - name: Verify ncalayer.zip checksum
        run: |
          echo "Verifying checksums..."
          make verify

      - name: Upload ncalayer.zip as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ncalayer-source
          path: ncalayer.zip
          retention-days: 90

  build-arch:
    needs: download-and-cache
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ncalayer.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: ncalayer-source

      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo wget unzip jre8-openjdk

      - name: Create build user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Build package
        run: |
          # Extract version from GitHub ref (refs/tags/v1.0.0 -> 1.0.0)
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          else
            VERSION="1.0.0"
          fi
          echo "Building version: $VERSION"

          PKGNAME=ncalayer
          mkdir -p /tmp/${PKGNAME}-${VERSION}
          cp -r . /tmp/${PKGNAME}-${VERSION}/
          rm -rf /tmp/${PKGNAME}-${VERSION}/.git
          tar czf ${PKGNAME}-${VERSION}.tar.gz -C /tmp ${PKGNAME}-${VERSION}
          chown builder:builder ${PKGNAME}-${VERSION}.tar.gz

          # Update PKGBUILD version
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" pkg/PKGBUILD
          sed -i "s|source=(.*)|source=(\"${PKGNAME}-${VERSION}.tar.gz\")|" pkg/PKGBUILD

          # Copy PKGBUILD and .install file to root for makepkg
          cp pkg/PKGBUILD .
          cp pkg/ncalayer.install .
          chown -R builder:builder .

          # Build as non-root user
          su - builder -c "cd $GITHUB_WORKSPACE && makepkg -cf --noconfirm"

      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: "*.pkg.tar.zst"

  build-deb:
    needs: download-and-cache
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ncalayer.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: ncalayer-source

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper devscripts wget unzip openjdk-8-jre

      - name: Update changelog version
        run: |
          # Extract version from GitHub ref (refs/tags/v1.0.0 -> 1.0.0)
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          else
            VERSION="1.0.0"
          fi
          echo "Building version: $VERSION"

          DEBFULLNAME="GitHub Actions" DEBEMAIL="actions@github.com" dch -v "${VERSION}-1" -D unstable "Automated release ${VERSION}"
          DEBFULLNAME="GitHub Actions" DEBEMAIL="actions@github.com" dch -r ""

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b
          mv ../*.deb .

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: "*.deb"

  build-rpm-fedora:
    needs: download-and-cache
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ncalayer.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: ncalayer-source

      - name: Install dependencies
        run: |
          dnf install -y rpm-build rpmdevtools make wget unzip git

      - name: Setup RPM build tree
        run: |
          rpmdev-setuptree
          mkdir -p ~/rpmbuild/SOURCES

          # Extract version from GitHub ref (refs/tags/v1.0.0 -> 1.0.0)
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          else
            VERSION="1.0.0"
          fi
          echo "Building version: $VERSION"

          # Update spec version for Fedora
          sed -i "s/^Version:.*/Version:        ${VERSION}/" pkg/ncalayer-fedora.spec

          # Create source tarball
          tar czf ~/rpmbuild/SOURCES/ncalayer-${VERSION}.tar.gz \
            --transform "s,^,ncalayer-${VERSION}/," \
            --exclude=.git \
            .

      - name: Build RPM package (Fedora with bundled Java)
        run: |
          rpmbuild -ba pkg/ncalayer-fedora.spec
          cp ~/rpmbuild/RPMS/x86_64/*.rpm .

      - name: Upload Fedora RPM package
        uses: actions/upload-artifact@v4
        with:
          name: rpm-fedora-package
          path: "*.rpm"

  build-rpm-rhel:
    needs: download-and-cache
    runs-on: ubuntu-latest
    container:
      image: rockylinux:8
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ncalayer.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: ncalayer-source

      - name: Install dependencies
        run: |
          dnf install -y rpm-build rpmdevtools make wget unzip java-1.8.0-openjdk git

      - name: Setup RPM build tree
        run: |
          rpmdev-setuptree
          mkdir -p ~/rpmbuild/SOURCES

          # Extract version from GitHub ref (refs/tags/v1.0.0 -> 1.0.0)
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          else
            VERSION="1.0.0"
          fi
          echo "Building version: $VERSION"

          # Update spec version for RHEL
          sed -i "s/^Version:.*/Version:        ${VERSION}/" pkg/ncalayer-rhel.spec

          # Create source tarball
          tar czf ~/rpmbuild/SOURCES/ncalayer-${VERSION}.tar.gz \
            --transform "s,^,ncalayer-${VERSION}/," \
            --exclude=.git \
            .

      - name: Build RPM package (RHEL with system Java)
        run: |
          rpmbuild -ba pkg/ncalayer-rhel.spec
          cp ~/rpmbuild/RPMS/x86_64/*.rpm .

      - name: Upload RHEL RPM package
        uses: actions/upload-artifact@v4
        with:
          name: rpm-rhel-package
          path: "*.rpm"

  build-appimage:
    needs: download-and-cache
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ncalayer.zip artifact
        uses: actions/download-artifact@v4
        with:
          name: ncalayer-source

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip libfuse2

      - name: Build AppImage
        run: |
          make appimage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage
          path: "NCALayer-*.AppImage"

  create-release:
    needs: [build-arch, build-deb, build-rpm-fedora, build-rpm-rhel, build-appimage]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 10

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/arch-package/*.pkg.tar.zst
            packages/debian-package/*.deb
            packages/rpm-fedora-package/*.rpm
            packages/rpm-rhel-package/*.rpm
            packages/appimage/NCALayer-*.AppImage
          draft: false
          prerelease: false
          body: |
            ## NCALayer Linux Distribution Packages

            ### Installation Instructions

            **Arch Linux:**
            ```bash
            sudo pacman -U ncalayer-*.pkg.tar.zst
            ncalayer-install-certs  # Install NCA certificates
            ncalayer                # Start application
            ```

            **Debian/Ubuntu:**
            ```bash
            sudo dpkg -i ncalayer_*.deb
            sudo apt-get install -f  # Install dependencies if needed
            ncalayer-install-certs  # Install NCA certificates
            ncalayer                # Start application
            ```

            **Fedora (with bundled Java):**
            ```bash
            sudo dnf install ncalayer-*fc*.rpm
            ncalayer                # Start application
            ```

            **RHEL/CentOS/Rocky Linux (with system Java):**
            ```bash
            sudo dnf install ncalayer-*el*.rpm
            ncalayer                # Start application
            ```

            **AppImage (Universal):**
            ```bash
            chmod +x NCALayer-x86_64.AppImage
            ./NCALayer-x86_64.AppImage --install-certs  # Install certificates
            ./NCALayer-x86_64.AppImage                   # Run application
            ```

            ### Package Information

            - **AppImage**: ~103MB (bundled JRE, fully portable, works on any Linux distro)
            - **Fedora RPM**: ~260MB (bundled Java 8, no dependencies)
            - **RHEL/CentOS RPM**: ~12MB (requires Java 8 from system)
            - **Debian/Ubuntu and Arch**: ~12MB (requires Java 8 from system)

            ### Requirements

            - **Fedora RPM**: certutil (nss-tools), optional: pcsc-lite
            - **RHEL/CentOS RPM**: Java 8 JRE, certutil (nss-tools), optional: pcsc-lite
            - **Debian/Ubuntu and Arch**: Java 8 JRE, certutil (nss-tools/libnss3-tools)
            - **AppImage**: No dependencies, fully self-contained
            - **Optional**: PC/SC libraries for smart card support

            ### Post-Installation

            After installation, run the certificate installer to add NCA certificates to your browsers:
            - Distribution packages: `ncalayer-install-certs`
            - AppImage: `./NCALayer-x86_64.AppImage --install-certs`

            This will install certificates for Firefox, Chrome, Chromium, and other browsers using NSS certificate databases.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
